<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öõÔ∏è Olivaris ‚Äî Trading Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  :root {
    --bg: #0a0b0f;
    --surface: #12131a;
    --surface2: #1a1b25;
    --border: #2a2b38;
    --text: #e8eaed;
    --text-muted: #6b7280;
    --text-dim: #4b5563;
    --green: #10b981;
    --green-bg: rgba(16, 185, 129, 0.1);
    --red: #ef4444;
    --red-bg: rgba(239, 68, 68, 0.1);
    --blue: #3b82f6;
    --blue-bg: rgba(59, 130, 246, 0.1);
    --purple: #a855f7;
    --purple-bg: rgba(168, 85, 247, 0.1);
    --orange: #f59e0b;
    --orange-bg: rgba(245, 158, 11, 0.1);
    --radius: 12px;
    --font: 'Inter', system-ui, -apple-system, sans-serif;
    --mono: 'JetBrains Mono', 'Fira Code', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
    line-height: 1.5;
  }
  .header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
  }
  .header-left h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em; }
  .header-left h1 span { color: var(--blue); }
  .header-sub { color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; font-family: var(--mono); }
  .header-right { display: flex; gap: 8px; align-items: center; }
  .badge { font-size: 0.7rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; font-family: var(--mono); }
  .badge-paulo { background: var(--blue-bg); color: var(--blue); border: 1px solid rgba(59,130,246,0.3); }
  .badge-andro { background: var(--purple-bg); color: var(--purple); border: 1px solid rgba(168,85,247,0.3); }
  .badge-poly { background: var(--orange-bg); color: var(--orange); border: 1px solid rgba(245,158,11,0.3); }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; animation: pulse 2s infinite; margin-right: 4px; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .live-label { font-size: 0.7rem; color: var(--green); font-family: var(--mono); }
  .section { margin-bottom: 28px; }
  .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 14px; }
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .summary-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 18px; transition: border-color 200ms ease;
  }
  .summary-card:hover { border-color: var(--text-dim); }
  .summary-card .label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; }
  .summary-card .value { font-size: 1.6rem; font-weight: 800; font-family: var(--mono); letter-spacing: -0.02em; }
  .summary-card .detail { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }
  .agent-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media(max-width: 768px) { .agent-grid { grid-template-columns: 1fr; } }
  .agent-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; position: relative; overflow: hidden;
  }
  .agent-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .agent-card.paulo::before { background: linear-gradient(90deg, var(--blue), #60a5fa); }
  .agent-card.andro::before { background: linear-gradient(90deg, var(--purple), #c084fc); }
  .agent-card.poly::before { background: linear-gradient(90deg, var(--orange), #fbbf24); }
  .agent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .agent-name { font-size: 1.1rem; font-weight: 800; }
  .agent-name.paulo { color: var(--blue); }
  .agent-name.andro { color: var(--purple); }
  .agent-name.poly { color: var(--orange); }
  .agent-role { font-size: 0.68rem; color: var(--text-muted); font-family: var(--mono); }
  .agent-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  .agent-stat .as-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .agent-stat .as-value { font-size: 1rem; font-weight: 700; font-family: var(--mono); margin-top: 2px; }
  .positions-table {
    width: 100%; border-collapse: collapse; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
  }
  .positions-table th {
    background: var(--surface2); color: var(--text-muted); font-size: 0.68rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em; padding: 10px 14px; text-align: left;
  }
  .positions-table td {
    padding: 10px 14px; border-top: 1px solid var(--border); font-size: 0.82rem;
    font-family: var(--mono); font-variant-numeric: tabular-nums;
  }
  .positions-table tr:hover { background: var(--surface2); }
  .agent-tag { font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
  .tag-paulo { background: var(--blue-bg); color: var(--blue); }
  .tag-andro { background: var(--purple-bg); color: var(--purple); }
  .tag-poly { background: var(--orange-bg); color: var(--orange); }
  .chart-container {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; margin-bottom: 14px;
  }
  .chart-container h2 { font-size: 0.85rem; font-weight: 700; margin-bottom: 14px; }
  canvas { max-height: 300px; }
  .charts-two { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media(max-width: 768px) { .charts-two { grid-template-columns: 1fr; } }
  .green { color: var(--green); }
  .red { color: var(--red); }
  .blue { color: var(--blue); }
  .purple { color: var(--purple); }
  .orange { color: var(--orange); }
  .neutral { color: var(--text); }
  .footer {
    color: var(--text-dim); font-size: 0.7rem; text-align: center; margin-top: 28px;
    padding-top: 16px; border-top: 1px solid var(--border); font-family: var(--mono);
  }
  .loading { text-align: center; padding: 40px; color: var(--text-muted); font-family: var(--mono); }
  .loading .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .poly-title-cell { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: var(--font); font-size: 0.78rem; }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>‚öõÔ∏è Oliv<span>aris</span> Trading</h1>
    <div class="header-sub">Depuis le 12 Feb 2026 00:01 CET ¬∑ MAJ: <span id="updateTime">chargement...</span></div>
  </div>
  <div class="header-right">
    <span class="live-dot"></span><span class="live-label">LIVE</span>
    <span class="badge badge-paulo">üß† Paulo</span>
    <span class="badge badge-andro">‚ö° Andro</span>
    <span class="badge badge-poly">üéØ PolyAgent</span>
  </div>
</div>

<div id="content">
  <div class="loading"><span class="spinner"></span> Chargement des donn√©es...</div>
</div>

<div class="footer">
  ‚öõÔ∏è Olivaris ¬∑ Claudio (COO) ¬∑ Paulo (Quant) ¬∑ Andro (Autonome) ¬∑ PolyAgent (Predictions) ¬∑ Road to $1,000 ¬∑ Dashboard v7 LIVE
</div>

<script>
const PAULO_WALLET = '0x73699b2aa74814b14Cb581BbF53A07A84140F942';
const ANDRO_WALLET = '0xeBee34176A218FA517Db163DD1A7aaA944c66d86';
const POLY_WALLET = '0x735366Ca234ebCb5f62F806eb5E66646ECaC6C3b';
const HL_API = 'https://api.hyperliquid.xyz/info';
const POLY_API = 'https://data-api.polymarket.com';
const TOTAL_DEPOSIT = 317.76;
const POLY_DEPOSIT = 70.00;
const PAULO_ALLOC = 219.76;
const ANDRO_ALLOC = 98.00;
const START_DATE = new Date('2026-02-12T00:01:00+01:00');
const POLY_START_DATE = '2026-02-15';

const gridColor = '#1e1f2e';
const tickColor = '#6b7280';
const BLUE = '#3b82f6';
const PURPLE = '#a855f7';
const GREEN = '#10b981';
const RED = '#ef4444';
const ORANGE = '#f59e0b';

// --- localStorage capital history for Polymarket ---
const POLY_HISTORY_KEY = 'olivaris_poly_capital_history';

function loadPolyHistory() {
  try { return JSON.parse(localStorage.getItem(POLY_HISTORY_KEY)) || []; }
  catch { return []; }
}

function savePolySnapshot(date, value, invested, pnl) {
  const history = loadPolyHistory();
  const existing = history.findIndex(h => h.date === date);
  const snap = { date, value: +value.toFixed(2), invested: +invested.toFixed(2), pnl: +pnl.toFixed(2), ts: Date.now() };
  if (existing >= 0) history[existing] = snap;
  else history.push(snap);
  history.sort((a, b) => a.date.localeCompare(b.date));
  localStorage.setItem(POLY_HISTORY_KEY, JSON.stringify(history));
  return history;
}

// --- Hyperliquid helpers ---
async function hlPost(type, params = {}) {
  const r = await fetch(HL_API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type, ...params })
  });
  return r.json();
}

// --- Polymarket helpers ---
async function fetchPolyPositions() {
  try {
    const r = await fetch(`${POLY_API}/positions?user=${POLY_WALLET}&sizeThreshold=0`);
    return await r.json();
  } catch { return []; }
}

async function fetchPolyActivity() {
  try {
    const r = await fetch(`${POLY_API}/activity?user=${POLY_WALLET}&limit=200`);
    return await r.json();
  } catch { return []; }
}

// --- Format helpers ---
function $(v) { return v >= 0 ? `$${v.toFixed(2)}` : `-$${Math.abs(v).toFixed(2)}`; }
function pct(v) { return (v >= 0 ? '+' : '') + v.toFixed(1) + '%'; }
function colorClass(v) { return v >= 0 ? 'green' : 'red'; }

function getDaysBetween(start, end) {
  const days = [];
  const d = new Date(start);
  d.setUTCHours(0, 0, 0, 0);
  const e = new Date(end);
  e.setUTCHours(0, 0, 0, 0);
  while (d <= e) {
    days.push(d.toISOString().slice(0, 10));
    d.setUTCDate(d.getUTCDate() + 1);
  }
  return days;
}

function buildDailyPnl(fills, startTs) {
  const days = {};
  for (const f of fills) {
    if (f.time < startTs) continue;
    const day = new Date(f.time).toISOString().slice(0, 10);
    const pnl = parseFloat(f.closedPnl || 0);
    const fee = parseFloat(f.fee || 0);
    if (!days[day]) days[day] = { pnl: 0, fees: 0, count: 0 };
    days[day].pnl += pnl;
    days[day].fees += fee;
    days[day].count += 1;
  }
  return days;
}

function fmtDate(d) {
  const [,m,day] = d.split('-');
  return `${parseInt(day)} ${['','Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'][parseInt(m)]}`;
}

async function loadDashboard() {
  try {
    const [pauloState, androState, pauloFills, androFills, polyPositions, polyActivity] = await Promise.all([
      hlPost('clearinghouseState', { user: PAULO_WALLET }),
      hlPost('clearinghouseState', { user: ANDRO_WALLET }),
      hlPost('userFills', { user: PAULO_WALLET }),
      hlPost('userFills', { user: ANDRO_WALLET }),
      fetchPolyPositions(),
      fetchPolyActivity(),
    ]);

    // --- Hyperliquid calcs ---
    const pauloEquity = parseFloat(pauloState.marginSummary.accountValue);
    const androEquity = parseFloat(androState.marginSummary.accountValue);
    const hlEquity = pauloEquity + androEquity;

    const pauloMarginUsed = parseFloat(pauloState.marginSummary.totalMarginUsed);
    const androMarginUsed = parseFloat(androState.marginSummary.totalMarginUsed);
    const pauloMarginPct = pauloEquity > 0 ? (pauloMarginUsed / pauloEquity * 100) : 0;
    const androMarginPct = androEquity > 0 ? (androMarginUsed / androEquity * 100) : 0;

    const startTs = START_DATE.getTime();
    const pauloDaily = buildDailyPnl(pauloFills, startTs);
    const androDaily = buildDailyPnl(androFills, startTs);

    const pauloPnlPeriod = Object.values(pauloDaily).reduce((s, d) => s + d.pnl - d.fees, 0);
    const androPnlPeriod = Object.values(androDaily).reduce((s, d) => s + d.pnl - d.fees, 0);

    const pauloTradesPeriod = Object.values(pauloDaily).reduce((s, d) => s + d.count, 0);
    const androTradesPeriod = Object.values(androDaily).reduce((s, d) => s + d.count, 0);

    const pauloPnlGlobal = pauloEquity - PAULO_ALLOC;
    const androPnlGlobal = androEquity - ANDRO_ALLOC;
    const hlPnlGlobal = hlEquity - TOTAL_DEPOSIT;

    // HL Capital curves
    const today = new Date();
    const dates = getDaysBetween(START_DATE, today);
    const pauloCurve = [];
    const androCurve = [];
    let pauloRemaining = 0;
    let androRemaining = 0;
    for (let i = dates.length - 1; i >= 0; i--) {
      const d = dates[i];
      pauloCurve.unshift(+(pauloEquity - pauloRemaining).toFixed(2));
      androCurve.unshift(+(androEquity - androRemaining).toFixed(2));
      pauloRemaining += (pauloDaily[d] ? pauloDaily[d].pnl - pauloDaily[d].fees : 0);
      androRemaining += (androDaily[d] ? androDaily[d].pnl - androDaily[d].fees : 0);
    }
    const hlTotalCurve = pauloCurve.map((p, i) => +(p + androCurve[i]).toFixed(2));
    const dateLabels = dates.map(fmtDate);

    // HL Positions
    const pauloPositions = (pauloState.assetPositions || [])
      .filter(p => parseFloat(p.position.szi) !== 0)
      .map(p => ({ ...p.position, agent: 'PAULO' }));
    const androPositions = (androState.assetPositions || [])
      .filter(p => parseFloat(p.position.szi) !== 0)
      .map(p => ({ ...p.position, agent: 'ANDRO' }));
    const allHlPositions = [...pauloPositions, ...androPositions];

    // Activity per day
    const pauloActivity = dates.map(d => pauloDaily[d]?.count || 0);
    const androActivity = dates.map(d => androDaily[d]?.count || 0);

    // --- Polymarket calcs ---
    let polyInvested = 0, polyCurrentValue = 0, polyPnl = 0;
    const openPolyPositions = [];
    const closedPolyPositions = [];

    for (const p of polyPositions) {
      const invested = parseFloat(p.initialValue || 0);
      const current = parseFloat(p.currentValue || 0);
      const cashPnl = parseFloat(p.cashPnl || 0);
      polyInvested += invested;
      polyCurrentValue += current;
      polyPnl += cashPnl;

      const pos = {
        title: p.title || '?',
        size: parseFloat(p.size || 0),
        avgPrice: parseFloat(p.avgPrice || 0),
        curPrice: parseFloat(p.curPrice || 0),
        invested: invested,
        current: current,
        pnl: cashPnl,
        pctPnl: parseFloat(p.percentPnl || 0),
        outcome: p.outcome || (p.outcomeIndex === 0 ? 'Yes' : 'No'),
        redeemable: p.redeemable,
        slug: p.slug || '',
      };
      // If curPrice is 0 or 1, it's resolved
      if (p.curPrice == 0 || p.curPrice == 1 || p.redeemable) {
        closedPolyPositions.push(pos);
      } else {
        openPolyPositions.push(pos);
      }
    }

    // Total value = current value of open positions + realized PnL from closed + remaining cash
    // currentValue = live mark-to-market of open positions
    // cashPnl includes realized gains/losses from resolved positions
    const polyTotalValue = polyCurrentValue + (POLY_DEPOSIT - polyInvested + polyPnl);
    const polyPnlPct = (polyPnl / POLY_DEPOSIT) * 100;
    const polyTrades = polyActivity.length;

    // Save today's snapshot
    const todayStr = today.toISOString().slice(0, 10);
    const polyHistory = savePolySnapshot(todayStr, polyTotalValue, polyInvested, polyPnl);

    // Grand total
    const grandEquity = hlEquity + polyTotalValue;
    const grandDeposit = TOTAL_DEPOSIT + POLY_DEPOSIT;
    const grandPnl = grandEquity - grandDeposit;

    // Update time
    document.getElementById('updateTime').textContent = new Date().toLocaleString('fr-FR', { timeZone: 'Europe/Paris', hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: 'short', year: 'numeric' });

    // === RENDER ===
    document.getElementById('content').innerHTML = `
      <!-- GLOBAL SUMMARY -->
      <div class="section">
        <div class="section-title">Vue d'ensemble</div>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="label">Capital Total</div>
            <div class="value neutral">${$(grandEquity)}</div>
            <div class="detail">HL ${$(hlEquity)} + Poly ${$(polyTotalValue)}</div>
          </div>
          <div class="summary-card">
            <div class="label">Total D√©pos√©</div>
            <div class="value neutral">${$(grandDeposit)}</div>
            <div class="detail">HL $${TOTAL_DEPOSIT} + Poly $${POLY_DEPOSIT}</div>
          </div>
          <div class="summary-card">
            <div class="label">PnL Global</div>
            <div class="value ${colorClass(grandPnl)}">${$(grandPnl)}</div>
            <div class="detail">${pct(grandPnl / grandDeposit * 100)} all-time</div>
          </div>
          <div class="summary-card">
            <div class="label">Hyperliquid</div>
            <div class="value ${colorClass(hlPnlGlobal)}">${$(hlPnlGlobal)}</div>
            <div class="detail">Paulo ${$(pauloPnlGlobal)} ¬∑ Andro ${$(androPnlGlobal)}</div>
          </div>
          <div class="summary-card">
            <div class="label">Polymarket</div>
            <div class="value ${colorClass(polyPnl)}">${$(polyPnl)}</div>
            <div class="detail">${pct(polyPnlPct)} ¬∑ ${polyTrades} trades ¬∑ ${openPolyPositions.length} open</div>
          </div>
          <!-- Positions Ouvertes card removed -->
        </div>
      </div>

      <!-- CAPITAL CHARTS -->
      <div class="section">
        <div class="section-title">üìà √âvolution du Capital</div>
        <div class="charts-two">
          <div class="chart-container">
            <h2>Hyperliquid ‚Äî Paulo vs Andro vs Total</h2>
            <canvas id="capitalChart"></canvas>
          </div>
          <div class="chart-container">
            <h2>Polymarket ‚Äî Capital</h2>
            <canvas id="polyCapitalChart"></canvas>
          </div>
        </div>
      </div>

      <!-- AGENT COMPARISON -->
      <div class="section">
        <div class="section-title">ü§ñ Agents</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;">
          <div class="agent-card paulo">
            <div class="agent-header">
              <div>
                <div class="agent-name paulo">üß† Paulo</div>
                <div class="agent-role">Agent Quant ¬∑ S4/S5/S6</div>
              </div>
              <span class="badge badge-paulo">ACTIF</span>
            </div>
            <div class="agent-stats">
              <div class="agent-stat"><div class="as-label">Capital</div><div class="as-value">${$(pauloEquity)}</div></div>
              <div class="agent-stat"><div class="as-label">PnL</div><div class="as-value ${colorClass(pauloPnlGlobal)}">${pct(pauloPnlGlobal / PAULO_ALLOC * 100)}</div></div>
              <div class="agent-stat"><div class="as-label">Marge</div><div class="as-value">${pauloMarginPct.toFixed(1)}%</div></div>
              <div class="agent-stat"><div class="as-label">Trades</div><div class="as-value">${pauloTradesPeriod}</div></div>
              <div class="agent-stat"><div class="as-label">PnL P√©riode</div><div class="as-value ${colorClass(pauloPnlPeriod)}">${$(pauloPnlPeriod)}</div></div>
              <div class="agent-stat"><div class="as-label">Positions</div><div class="as-value">${pauloPositions.length}</div></div>
            </div>
          </div>
          <div class="agent-card andro">
            <div class="agent-header">
              <div>
                <div class="agent-name andro">‚ö° Andro</div>
                <div class="agent-role">Trader Autonome ¬∑ SDK</div>
              </div>
              <span class="badge badge-andro">ACTIF</span>
            </div>
            <div class="agent-stats">
              <div class="agent-stat"><div class="as-label">Capital</div><div class="as-value">${$(androEquity)}</div></div>
              <div class="agent-stat"><div class="as-label">PnL</div><div class="as-value ${colorClass(androPnlGlobal)}">${pct(androPnlGlobal / ANDRO_ALLOC * 100)}</div></div>
              <div class="agent-stat"><div class="as-label">Marge</div><div class="as-value">${androMarginPct.toFixed(1)}%</div></div>
              <div class="agent-stat"><div class="as-label">Trades</div><div class="as-value">${androTradesPeriod}</div></div>
              <div class="agent-stat"><div class="as-label">PnL P√©riode</div><div class="as-value ${colorClass(androPnlPeriod)}">${$(androPnlPeriod)}</div></div>
              <div class="agent-stat"><div class="as-label">Positions</div><div class="as-value">${androPositions.length}</div></div>
            </div>
          </div>
          <div class="agent-card poly">
            <div class="agent-header">
              <div>
                <div class="agent-name poly">üéØ PolyAgent</div>
                <div class="agent-role">Prediction Markets</div>
              </div>
              <span class="badge badge-poly">LIVE</span>
            </div>
            <div class="agent-stats">
              <div class="agent-stat"><div class="as-label">Capital</div><div class="as-value">${$(polyTotalValue)}</div></div>
              <div class="agent-stat"><div class="as-label">PnL</div><div class="as-value ${colorClass(polyPnl)}">${pct(polyPnlPct)}</div></div>
              <div class="agent-stat"><div class="as-label">Investi</div><div class="as-value">${$(polyInvested)}</div></div>
              <div class="agent-stat"><div class="as-label">Trades</div><div class="as-value">${polyTrades}</div></div>
              <div class="agent-stat"><div class="as-label">Valeur Pos.</div><div class="as-value">${$(polyCurrentValue)}</div></div>
              <div class="agent-stat"><div class="as-label">Positions</div><div class="as-value">${openPolyPositions.length}</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- HL POSITIONS -->
      <div class="section">
        <div class="section-title">üìç Positions Hyperliquid</div>
        ${allHlPositions.length > 0 ? `
        <table class="positions-table">
          <thead><tr><th>Agent</th><th>Coin</th><th>Side</th><th>Size</th><th>Entry</th><th>uPnL</th><th>Lev</th></tr></thead>
          <tbody>
            ${allHlPositions.map(p => {
              const szi = parseFloat(p.szi);
              const isLong = szi > 0;
              const upnl = parseFloat(p.unrealizedPnl);
              const lev = p.leverage ? (p.leverage.value + '√ó') : '‚Äî';
              const tagClass = p.agent === 'PAULO' ? 'tag-paulo' : 'tag-andro';
              return `<tr>
                <td><span class="agent-tag ${tagClass}">${p.agent}</span></td>
                <td><strong>${p.coin}</strong></td>
                <td class="${isLong ? 'green' : 'red'}">${isLong ? 'LONG' : 'SHORT'}</td>
                <td>${Math.abs(szi)}</td>
                <td>$${parseFloat(p.entryPx).toFixed(4)}</td>
                <td class="${colorClass(upnl)}">${$(upnl)}</td>
                <td>${lev}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>` : `<div style="color:var(--text-muted);font-family:var(--mono);font-size:0.82rem;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);">Aucune position ouverte</div>`}
      </div>

      <!-- POLY POSITIONS -->
      <div class="section">
        <div class="section-title">üéØ Positions Polymarket</div>
        ${openPolyPositions.length > 0 ? `
        <table class="positions-table">
          <thead><tr><th>March√©</th><th>Shares</th><th>Avg</th><th>Prix</th><th>Investi</th><th>Valeur</th><th>PnL</th></tr></thead>
          <tbody>
            ${openPolyPositions.sort((a,b) => b.invested - a.invested).map(p => {
              return `<tr>
                <td class="poly-title-cell" title="${p.title}">${p.title}</td>
                <td>${p.size.toFixed(2)}</td>
                <td>${(p.avgPrice * 100).toFixed(1)}¬¢</td>
                <td>${(p.curPrice * 100).toFixed(1)}¬¢</td>
                <td>${$(p.invested)}</td>
                <td>${$(p.current)}</td>
                <td class="${colorClass(p.pnl)}">${$(p.pnl)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>` : `<div style="color:var(--text-muted);font-family:var(--mono);font-size:0.82rem;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);">Aucune position ouverte</div>`}
        ${closedPolyPositions.length > 0 ? `
        <div style="margin-top:10px;">
          <details>
            <summary style="cursor:pointer;color:var(--text-muted);font-family:var(--mono);font-size:0.75rem;">
              ${closedPolyPositions.length} position(s) r√©solue(s)
            </summary>
            <table class="positions-table" style="margin-top:8px;opacity:0.7;">
              <thead><tr><th>March√©</th><th>Shares</th><th>Avg</th><th>R√©sultat</th><th>PnL</th></tr></thead>
              <tbody>
                ${closedPolyPositions.map(p => {
                  const won = p.curPrice == 1;
                  return `<tr>
                    <td class="poly-title-cell" title="${p.title}">${p.title}</td>
                    <td>${p.size.toFixed(2)}</td>
                    <td>${(p.avgPrice * 100).toFixed(1)}¬¢</td>
                    <td class="${won ? 'green' : 'red'}">${won ? '‚úÖ WIN' : '‚ùå LOSS'}</td>
                    <td class="${colorClass(p.pnl)}">${$(p.pnl)}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </details>
        </div>` : ''}
      </div>

      <!-- CHARTS -->
      <div class="section">
        <div class="section-title">üìä Performance</div>
        <div class="charts-two">
          <div class="chart-container"><h2>Activit√© Trading HL (fills/jour)</h2><canvas id="activityChart"></canvas></div>
          <div class="chart-container"><h2>R√©partition du Capital</h2><canvas id="capitalPie"></canvas></div>
        </div>
        <div class="charts-two">
          <div class="chart-container"><h2>Marge Utilis√©e HL</h2><canvas id="marginChart"></canvas></div>
          <div class="chart-container"><h2>PnL par Agent</h2><canvas id="pnlCompare"></canvas></div>
        </div>
      </div>
    `;

    // === CHARTS ===
    const ttOpts = { backgroundColor: '#1a1b25', borderColor: '#2a2b38', borderWidth: 1, titleFont: { family: "'Inter'" }, bodyFont: { family: "'JetBrains Mono'" } };

    // HL Capital
    new Chart(document.getElementById('capitalChart'), {
      type: 'line',
      data: {
        labels: dateLabels,
        datasets: [
          { label: 'Total HL', data: hlTotalCurve, borderColor: GREEN, backgroundColor: 'rgba(16,185,129,0.08)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: GREEN, borderWidth: 2.5 },
          { label: 'Paulo', data: pauloCurve, borderColor: BLUE, backgroundColor: 'rgba(59,130,246,0.05)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: BLUE, borderWidth: 2 },
          { label: 'Andro', data: androCurve, borderColor: PURPLE, backgroundColor: 'rgba(168,85,247,0.05)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: PURPLE, borderWidth: 2 },
          { label: 'D√©part', data: dateLabels.map(() => TOTAL_DEPOSIT), borderColor: '#374151', borderDash: [6, 4], pointRadius: 0, borderWidth: 1, fill: false }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { labels: { color: tickColor, usePointStyle: true, pointStyle: 'circle', padding: 16, font: { family: "'Inter'", size: 11 } } }, tooltip: { ...ttOpts, callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}` } } },
        scales: { x: { ticks: { color: tickColor }, grid: { color: gridColor } }, y: { ticks: { color: tickColor, callback: v => '$' + v }, grid: { color: gridColor } } }
      }
    });

    // Poly Capital
    if (polyHistory.length > 0) {
      const polyDates = polyHistory.map(h => fmtDate(h.date));
      const polyValues = polyHistory.map(h => h.value);
      new Chart(document.getElementById('polyCapitalChart'), {
        type: 'line',
        data: {
          labels: polyDates,
          datasets: [
            { label: 'Capital Poly', data: polyValues, borderColor: ORANGE, backgroundColor: 'rgba(245,158,11,0.08)', fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: ORANGE, borderWidth: 2.5 },
            { label: 'D√©part', data: polyDates.map(() => POLY_DEPOSIT), borderColor: '#374151', borderDash: [6, 4], pointRadius: 0, borderWidth: 1, fill: false }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { labels: { color: tickColor, usePointStyle: true, pointStyle: 'circle', padding: 16, font: { family: "'Inter'", size: 11 } } }, tooltip: { ...ttOpts, callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)}` } } },
          scales: { x: { ticks: { color: tickColor }, grid: { color: gridColor } }, y: { ticks: { color: tickColor, callback: v => '$' + v }, grid: { color: gridColor } } }
        }
      });
    } else {
      document.getElementById('polyCapitalChart').parentElement.innerHTML = '<h2>Polymarket ‚Äî Capital</h2><div style="color:var(--text-muted);font-family:var(--mono);font-size:0.8rem;padding:20px;text-align:center;">Premier snapshot enregistr√©. La courbe se construit √† chaque visite.</div>';
    }

    // Capital Pie (3 agents)
    new Chart(document.getElementById('capitalPie'), {
      type: 'doughnut',
      data: { labels: ['Paulo', 'Andro', 'PolyAgent'], datasets: [{ data: [pauloEquity, androEquity, polyTotalValue], backgroundColor: [BLUE, PURPLE, ORANGE], borderColor: '#12131a', borderWidth: 3 }] },
      options: { responsive: true, cutout: '60%', plugins: { legend: { labels: { color: tickColor, usePointStyle: true, padding: 16 }, position: 'bottom' }, tooltip: { ...ttOpts, callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toFixed(2)} (${((ctx.parsed / grandEquity) * 100).toFixed(0)}%)` } } } }
    });

    // Activity
    new Chart(document.getElementById('activityChart'), {
      type: 'bar',
      data: { labels: dateLabels, datasets: [
        { label: 'Paulo', data: pauloActivity, backgroundColor: 'rgba(59,130,246,0.6)', borderRadius: 6 },
        { label: 'Andro', data: androActivity, backgroundColor: 'rgba(168,85,247,0.6)', borderRadius: 6 }
      ]},
      options: { responsive: true, plugins: { legend: { labels: { color: tickColor, usePointStyle: true, pointStyle: 'circle' } } }, scales: { x: { ticks: { color: tickColor }, grid: { color: gridColor } }, y: { ticks: { color: tickColor }, grid: { color: gridColor } } } }
    });

    // Margin
    new Chart(document.getElementById('marginChart'), {
      type: 'bar',
      data: { labels: ['Paulo', 'Andro'], datasets: [
        { label: 'Marge Utilis√©e', data: [pauloMarginPct, androMarginPct], backgroundColor: ['rgba(59,130,246,0.6)', 'rgba(168,85,247,0.6)'], borderRadius: 8 },
        { label: 'Seuil Danger (75%)', data: [75, 75], backgroundColor: 'rgba(239,68,68,0.15)', borderRadius: 0 }
      ]},
      options: { responsive: true, plugins: { legend: { labels: { color: tickColor } } }, scales: { x: { stacked: false, ticks: { color: tickColor }, grid: { color: gridColor } }, y: { max: 100, ticks: { color: tickColor, callback: v => v + '%' }, grid: { color: gridColor } } } }
    });

    // PnL Compare (3 agents)
    new Chart(document.getElementById('pnlCompare'), {
      type: 'bar',
      data: { labels: ['Paulo', 'Andro', 'PolyAgent'], datasets: [{ label: 'PnL ($)', data: [pauloPnlGlobal, androPnlGlobal, polyPnl], backgroundColor: [pauloPnlGlobal >= 0 ? BLUE : RED, androPnlGlobal >= 0 ? PURPLE : RED, polyPnl >= 0 ? ORANGE : RED], borderRadius: 8 }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: tickColor }, grid: { color: gridColor } }, y: { ticks: { color: tickColor, callback: v => '$' + v }, grid: { color: gridColor } } } }
    });

  } catch (err) {
    document.getElementById('content').innerHTML = `<div class="loading" style="color:var(--red);">‚ùå Erreur: ${err.message}<br><br><button onclick="loadDashboard()" style="padding:8px 16px;background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:8px;cursor:pointer;font-family:var(--mono);">R√©essayer</button></div>`;
  }
}

loadDashboard();
</script>
</body>
</html>
